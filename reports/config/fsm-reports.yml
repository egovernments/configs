ReportDefinitions:
  - reportName: FSMDailyCollectionReport 
    decryptionPathId: FSMDailyCollectionReport
    summary: Report is used for check FSM daily collection. 
    version: 1.0.0
    moduleName: fsm
    sourceColumns:
      - name: receiptdate
        label: REPORT_FSM_RESULT_RECEIPTDATE
        type: string
        source: fsm
        total: false
      - name: receiptnumber
        label: REPORT_FSM_RESULT_RECEIPTNUMBER
        type: string
        source: fsm
        total: false
      - name: applicationno
        label: REPORT_FSM_RESULT_APPLICATIONNO
        type: string
        source: fsm
        total: false
      - name: name
        label: REPORT_FSM_RESULT_APPLICANTNAME
        type: string
        source: fsm
        total: false
      - name: uuid
        label: REPORT_FSM_RESULT_USER_UUID
        type: string
        source: fsm
        showColumn: false
      - name: instrumenttype
        label: REPORT_FSM_RESULT_PAYMENTMODE
        type: string
        source: fsm
        total: false  
      - name: chequedate
        label: REPORT_FSM_RESULT_CHEQUEDATE
        type: string
        source: fsm
        total: false
      - name: chequeno
        label: REPORT_FSM_RESULT_CHEQUENO
        type: string
        source: fsm
        total: false   
      - name: bankname
        label: REPORT_FSM_RESULT_BANKNAME
        type: string
        source: fsm
        total: false        
      - name: transactionid
        label: REPORT_FSM_RESULT_TRANSACTIONID
        type: string
        source: fsm
        total: false
      - name: carddigit
        label: REPORT_FSM_RESULT_CARDDIGIT
        type: string
        source: fsm
        total: false    
      - name: amount
        label: REPORT_FSM_RESULT_AMOUNT
        type: string
        source: fsm
        total: true
      - name: status
        label: REPORT_FSM_RESULT_STATUS
        type: string
        source: fsm
        total: false
    searchParams:
      - name: fromDate
        label: REPORTS_FSM_PARAM_FROMDATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime >= $fromDate
      - name: toDate
        label: REPORTS_FSM_PARAM_TODATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime <= $toDate 
      - name: instrumentType
        label: REPORTS_FSM_PARAM_INSTRUMENTTYPE
        type: singlevaluelist
        pattern: 'list://CASH:CASH,ONLINE:ONLINE,CARD:CARD,DD:DD,CHEQUE:CHEQUE'
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND pay.paymentmode = $instrumentType
      - name: collectionOperator
        label: REPORTS_FSM_PARAM_COLLECTIONOPERATOR
        type: singlevaluelist
        pattern: http://egov-hrms:8080/egov-hrms/employees/_search?tenantId=$tenantid&roles=FSM_COLLECTOR|$.Employees[*].user.id|$.Employees[*].user.name|$.Employees[*].user.username
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND pay.createdby= $collectionOperator
      - name: status
        label: REPORTS_FSM_PARAM_STATUS
        type: singlevaluelist
        pattern: 'list://NEW:NEW,DEPOSITED:DEPOSITED,CANCELLED:CANCELLED,DISHONOURED:DISHONOURED'
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND pay.paymentstatus = $status
      - name: dsoId
        label: REPORTS_FSM_PARAM_DSONAME
        type: singlevaluelist
        pattern: http://vendor.sanitation:8080/vendor/v1/_search?tenantId=$tenantid|$.vendor.*.id|$.vendor.*.name
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND app.dso_id = $dsoId
    query: |
          select To_char(To_timestamp(paydl.receiptdate / 1000), 'DD/MM/YYYY')  as receiptdate, paydl.receiptnumber as receiptnumber,b.consumercode AS applicationno,(select name from eg_user where uuid=app.accountid ) as name,app.accountid as uuid,  pay.paymentmode as instrumenttype, (case when (pay.paymentmode like 'CHEQUE' OR pay.paymentmode like 'DD') then To_char(To_timestamp(pay.instrumentdate / 1000), 'DD/MM/YYYY')  else  'NA' end)  as chequedate, (case when (pay.paymentmode like 'CHEQUE' OR pay.paymentmode like 'DD') then pay.instrumentnumber else  'NA' end) as chequeno, (case when (pay.paymentmode like 'CHEQUE' OR pay.paymentmode like 'DD') then pay.additionaldetails::json#>>'{bankDetails,BANK}'  else  'NA' end) as bankname, pay.transactionnumber as transactionid, (case when pay.paymentmode='CARD' then pay.instrumentnumber else  '' end) as carddigit, bd.amount as amount,pay.paymentstatus as status from egcl_bill b inner join egcl_billdetial bd ON b.id = bd.billid AND b.tenantid = bd.tenantid INNER JOIN eg_fsm_application app on b.consumercode =app.applicationno and b.tenantid =app.tenantid inner join egcl_paymentdetail paydl   ON b.id = paydl.billid    AND b.tenantid = paydl.tenantid inner join egcl_payment pay  ON paydl.paymentid = pay.id and   paydl.tenantid =pay.tenantid where pay.tenantid=$tenantid and b.businessservice ='FSM.TRIP_CHARGES' 
    orderby: order by paydl.receiptdate  desc
    
  - reportName: FSMRequestReport
    summary: Report gives the highlevel information of FSM Requests
    version: 1.0.0
    moduleName: fsm
    externalService:
      - entity: $.TenantBoundary[0].boundary
        apiURL: http://egov-location.egov:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=ADMIN&boundaryType=Locality&tenantId=$tenantId
        keyOrder: name,code
        tableName: fsm_boundary
    sourceColumns:
      - name: tenantid
        label: Tenant
        type: string
        source: fsm
      - name: ApplicationId
        label: REPORT_FSM_RESULT_APPLICATION_NO
        type: string
        source: fsm
      - name: ApplicationStatus
        label: Application Status
        type: string
        source: fsm
      - name: noOfTrips
        label: REPORT_FSM_RESULT_No_OF_TRIPS
        type: string
        source: fsm
      - name: PropertyType
        label: PropertyT ype
        type: string
        source: fsm
      - name: PropertySubType
        label: Property Sub Type
        type: string
        source: fsm
      - name: proprtyTypeSubType
        label: REPORT_FSM_RESULT_PROPERTYSUBTYPE
        type: string
        source: fsm
      - name: UrbanRuralFlag
        label: Urban Rural Flag
        type: string
        source: fsm
      - name: locality
        label: Locality
        type: string
        source: fsm
      - name: GP
        label: Gram Panchayat
        type: string
        source: fsm
      - name: SlumName
        label: Slum Name
        type: currency
        source: fsm
      - name: DesludgingVehicleNumber
        label: Desludging Vehicle Number
        type: string
        source: fsm
      - name: VehicleOwner
        label: Vehicle OwnerShip
        type: string
        source: fsm
      - name: VehicleCapacity
        label: Vehicle Capacity
        type: string
        source: fsm
      - name: TotalAmount
        label: Total Amount to be Collected
        type: string
        source: fsm
        total: true
      - name: AdvanceAmount
        label: Advance Amount
        type: string
        source: fsm
        total: true
      - name: PaymentAmount
        label: Payment Amount
        type: string
        source: fsm
        total: true
      - name: ApplicationSubmitDate
        label: Application Submitted Date
        type: currency
        source: fsm
      - name: Rating
        label: Rating
        type: string
        source: fsm
      - name: Comment
        label: Reason for Rejection/Cancellation
        type: string
        source: fsm
    searchParams:
      - name: fromDate
        label: REPORTS_FSM_PARAM_FROMDATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND fsm.createdtime >= $fromDate
      - name: toDate
        label: REPORTS_FSM_PARAM_TODATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND fsm.createdtime <= $toDate
      - name: status
        label: REPORTS_FSM_PARAM_STATUS
        type: singlevaluelist
        pattern: 'list://CREATED:Created,CITIZEN_FEEDBACK_PENDING:Citizen feedback pending,PENDING_DSO_APPROVAL:Pending DSO Approval,REJECTED:Rejected,ASSING_DSO:Assign DSO,DSO_INPROGRESS:DSO in Progress,CANCELED:Cancelled,COMPLETED:Conpleted,PENDING_APPL_FEE_PAYMENT:Pending application fee payment'
        source: rainmaker-fsm
        wrapper: true
        isMandatory: false
        searchClause: AND REPLACE (fsm.applicationstatus, '_', ',') = $status
      - name: locality
        label: REPORTS_FSM_PARAM_LOCALITY
        type: singlevaluelist
        pattern: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=ADMIN&boundaryType=Locality&tenantId=$tenantid|$.TenantBoundary[0].boundary.*.code|$.TenantBoundary[0].boundary.*.name
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND address.locality = $locality
    query: |
          SELECT INITCAP(SPLIT_PART(fsm.tenantid,'.',2)) as tenantid, 
          fsm.applicationno AS ApplicationId, 
          COALESCE(INITCAP(REPLACE(fsm.applicationStatus, '_', ' ')), 'N/A') AS ApplicationStatus,
          COALESCE(fsm.nooftrips, 0) AS Nooftrips,  
          INITCAP(split_part(fsm.propertyusage::TEXT, '.', 1)) AS PropertyType, 
          CASE 
                WHEN split_part(fsm.propertyusage::TEXT, '.', 2) != '' 
                THEN INITCAP(REPLACE(split_part(fsm.propertyusage::TEXT, '.', 2), '_', ' '))
                ELSE 'N/A' 
          END AS PropertySubType, 
          CAST(COALESCE(fsmaddress.additionaldetails->>'boundaryType', '{}') AS TEXT) as UrbanRuralFlag, 
          boundary.name as locality, 
          CAST(COALESCE(fsmaddress.additionaldetails->'gramPanchayat'->>'name', '{}') AS TEXT) as GP, 
          COALESCE(fsmaddress.slumname, 'N/A') AS SlumName, 
          COALESCE(fsmvehicle.registrationNumber, 'N/A') AS DesludgingVehicleNumber, 
          COALESCE(fsmvehicle.vehicleowner, 'N/A') AS VehicleOwner,  
          COALESCE(fsmvehicle.tankcapicity, 0) AS VehicleCapacity, 
          CAST(COALESCE(NULLIF(fsm.additionaldetails->>'tripAmount', '')::NUMERIC * fsm.nooftrips, 0) AS NUMERIC) AS TotalAmount,
          COALESCE(fsm.advanceamount, 0) AS AdvanceAmount, 
          COALESCE(fsmpayment.totalamountpaid, 0) AS PaymentAmount, 
          TO_CHAR(TO_TIMESTAMP(fsm.createdtime / 1000)::timestamp AT TIME ZONE 'Asia/Kolkata', 'MM/DD/YYYY HH24:MI:SS') AS ApplicationSubmitDate, 
          COALESCE(pirating.rating, 0 ) AS Rating, 
          COALESCE(picomment.comment, 'N/A') AS Comment 
          FROM eg_fsm_application AS fsm 
          JOIN eg_fsm_address AS fsmaddress ON (fsmaddress.fsm_id = fsm.id) 
          JOIN eg_fsm_geolocation AS fsmgeolocation ON (fsmaddress.id = fsmgeolocation.address_id) 
          LEFT JOIN eg_vendor AS fsmdso ON (fsmdso.id = fsm.dso_id) 
          LEFT JOIN eg_vehicle AS fsmvehicle ON (fsm.vehicle_id = fsmvehicle.id) 
          LEFT JOIN egcl_bill AS egbill ON (egbill.consumercode = fsm.applicationno) 
          LEFT JOIN egcl_paymentdetail AS paymentdl ON (paymentdl.billid = egbill.id) 
          LEFT JOIN egcl_payment AS fsmpayment ON (fsmpayment.id = paymentdl.paymentid) 
          LEFT JOIN (SELECT pi.rating, pi.businessId FROM eg_wf_processinstance_v2 pi JOIN eg_wf_state_v2 status ON (status.uuid = pi.status) WHERE status.state = 'COMPLETED') pirating ON (pirating.businessId = fsm.applicationno) 
          LEFT JOIN (SELECT pi.comment, pi.businessId FROM eg_wf_processinstance_v2 pi JOIN eg_wf_state_v2 status ON (status.uuid = pi.status) WHERE status.state IN ('REJECTED', 'CANCELED', 'DSO_REJECTED')) picomment ON (picomment.businessId = fsm.applicationno) 
          LEFT  JOIN (VALUES fsm_boundary) AS boundary(name,code) ON (boundary.code = fsmaddress.locality)
          WHERE fsm.tenantid=$tenantid 
          AND fsm.additionaldetails->>'tripAmount' NOT IN ('', '[]')
    orderby: ORDER BY fsm.applicationNo
    
  - reportName: FSMVehicleLogReport
    summary: FSM Vehicle Trip.
    version: 1.0.0
    moduleName: fsm
    sourceColumns:
      - name: tenantid
        label: Ulb Name
        type: string
        source: fsm
        total: false
      - name: ApplicationId
        label: Application Number
        type: string
        source: fsm
        total: false
      - name: VehicleTripId
        label: Vehicle Trip Id
        type: string
        source: fsm
        total: false
      - name: Vehicle_Application_Status
        label: Vehicle Application Status
        type: string
        source: fsm
        total: false
      - name: urbanRuralFlag
        label: Urban Rural Flag
        type: string
        source: fsm
        total: false
      - name: DesludgingVehicleNumber
        label: Desludging Vehicle Number
        type: string
        source: fsm
        total: false
      - name: VehicleType
        label: Vehicle Type
        type: string
        source: fsm
        total: false
      - name: vehicleowner
        label: Vehicle Owner
        type: string
        source: fsm
        total: false
      - name: VehicleCapacity
        label: Vehicle Capacity
        type: string
        source: fsm
        total: false
      - name: WasteCollected
        label: Waste Collected
        type: string
        source: fsm
        total: true
      - name: WasteDumped
        label: Waste Dumped
        type: string
        source: fsm
        total: true  
      - name: VehicleOutDateTime
        label: Vehicle Out Date Time
        type: string
        source: fsm
        total: false  
      - name: ApplicationSubmitDate
        label: Application Submit Date
        type: string
        source: fsm
        total: false
      - name: slaInDay
        label: SLA In Day
        type: string
        source: fsm
        total: false
      - name: slaInHourss
        label: SLA In Hours
        type: string
        source: fsm
        total: false    
    searchParams:
      - name: fromDate
        label: REPORTS_FSM_PARAM_FROMDATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND fsmvehicleTrip.createdtime >= $fromDate
      - name: toDate
        label: REPORTS_FSM_PARAM_TODATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND fsmvehicleTrip.createdtime <= $toDate
      - name: vehicleNo
        label: REPORTS_FSM_PARAM_VEHICLENUMBER
        type: string
        source: fsm
        isMandatory: false
        searchClause: AND fsmvehicle.registrationnumber ilike '%'||$vehicleNo||'%'
      - name: vehicleCapacity
        label: REPORTS_FSM_PARAM_VEHICLECAPACITY
        type: string
        source: fsm
        isMandatory: false
        searchClause: AND fsmvehicle.tankcapicity = CAST($vehicleCapacity AS INTEGER)
      - name: applicationStatus
        label: REPORTS_FSM_PARAM_APPLICATIONSTATUS
        type: string
        source: fsm
        isMandatory: false
        searchClause: AND fsmvehicleTrip.applicationstatus = $applicationStatus
    query: |
          SELECT INITCAP(SPLIT_PART(fsm.tenantid,'.',2)) as tenantid, 
          fsm.applicationno::TEXT AS ApplicationId,
          fsmvehicleTrip.applicationno::TEXT AS VehicleTripId,
          INITCAP(REPLACE(fsmvehicleTrip.applicationstatus, '_', ' ')) AS Vehicle_Application_Status,
          CASE WHEN fsmaddress.additionaldetails->>'boundaryType'='GP' THEN 'Rural' ELSE 'Urban' END AS urbanRuralFlag,
          COALESCE(fsmvehicle.registrationNumber, 'N/A')::TEXT AS DesludgingVehicleNumber,
          COALESCE(INITCAP(REPLACE(REPLACE(fsmvehicle.type, '_', ' '), '.', ' ')), 'N/A') AS VehicleType,
          fsmvehicle.vehicleowner::TEXT AS vehicleowner,
          COALESCE(fsmvehicle.tankcapicity, 0) AS VehicleCapacity,
          COALESCE(fsmvehicleTripdetail.volume, 0) AS WasteCollected,
          COALESCE(fsmvehicleTrip.volumeCarried, 0) AS WasteDumped,
          CASE
              WHEN length(cast(tripendtime AS varchar)) = 13 THEN
                  to_char((to_timestamp(fsmvehicleTrip.tripendtime / 1000)::timestamp AT TIME ZONE 'Asia/Kolkata'), 'mm/dd/yyyy HH24:MI:SS')
              WHEN length(cast(tripendtime AS varchar)) = 10 THEN
                  to_char((to_timestamp(fsmvehicleTrip.tripendtime)::timestamp AT TIME ZONE 'Asia/Kolkata'), 'mm/dd/yyyy HH24:MI:SS')
              ELSE '0'
          END AS VehicleOutDateTime,
          to_char((to_timestamp(fsm.createdtime / 1000)::timestamp AT TIME ZONE 'Asia/Kolkata'), 'mm/dd/yyyy HH24:MI:SS')::TEXT AS ApplicationSubmitDate,
          CASE
              WHEN length(cast(tripendtime AS varchar)) = 13 THEN ((fsmvehicleTrip.tripendtime - fsm.createdtime) / (1000 * 60 * 60 * 24))::TEXT
              WHEN length(cast(tripendtime AS varchar)) = 10 THEN ((fsmvehicleTrip.tripendtime - fsm.createdtime / 1000) / (60 * 60 * 24))::TEXT
              ELSE '0'
          END AS slaInDay,
          CASE
              WHEN length(cast(tripendtime AS varchar)) = 13 THEN ((fsmvehicleTrip.tripendtime - fsm.createdtime) / (1000 * 60 * 60) + 1)::TEXT
              WHEN length(cast(tripendtime AS varchar)) = 10 THEN ((fsmvehicleTrip.tripendtime - fsm.createdtime / 1000) / (60 * 60) + 1)::TEXT
              ELSE '0'
          END AS slaInHours,
          CASE
              WHEN length(cast(tripendtime AS varchar)) = 13 THEN  
                  CASE WHEN ((fsmvehicleTrip.tripendtime - fsm.createdtime) / (1000 * 60 * 60)) > 72 THEN '>72 hrs'::TEXT
                       ELSE '<72 hrs'::TEXT
                  END  
              WHEN length(cast(tripendtime AS varchar)) = 10 THEN  
                  CASE WHEN ((fsmvehicleTrip.tripendtime - fsm.createdtime / 1000) / (60 * 60)) > 72 THEN '>72 hrs'::TEXT
                       ELSE '<72 hrs'::TEXT
                  END
              ELSE '0'
          END AS slaInHourss
          FROM eg_fsm_application AS fsm
          JOIN eg_fsm_address AS fsmaddress ON (fsmaddress.fsm_id = fsm.id)
          LEFT JOIN eg_vendor AS fsmdso ON (fsmdso.id = fsm.dso_id)  
          LEFT JOIN eg_vehicle AS fsmvehicle ON (fsm.vehicle_id = fsmvehicle.id)
          LEFT JOIN eg_vehicle_trip_detail AS fsmvehicleTripdetail ON (fsmvehicleTripdetail.referenceNo = fsm.applicationNo)
          LEFT JOIN eg_vehicle_trip AS fsmvehicleTrip ON (fsmvehicleTripdetail.trip_id = fsmvehicleTrip.id) 
          WHERE fsmvehicleTrip.tenantid=$tenantid 
    orderby: ORDER BY fsm.applicationno ASC
    
  - reportName: FSMDailyDesludingReport
    summary: Report is used to  check FSM daily desludging request 
    version: 1.0.0
    moduleName: fsm
    externalService:
      - entity: $.messages
        apiURL: http://egov-localization.egov:8080/localization/messages/v1/_search?locale=en_IN&tenantId=pg&module=rainmaker-fsm&codes=CS_COMMON_FSM_PENDING_DSO_APPROVAL,CS_COMMON_FSM_CREATED,CS_COMMON_FSM_PENDING_APPL_FEE_PAYMENT,CS_COMMON_FSM_ASSING_DSO,CS_COMMON_FSM_DSO_REJECTED,CS_COMMON_FSM_DSO_INPROGRESS,CS_COMMON_FSM_PENDING_DSO_APPROVAL,CS_COMMON_FSM_COMPLETED,CS_COMMON_FSM_REJECTED,CS_COMMON_FSM_CANCELED,CS_COMMON_FSM_CITIZEN_FEEDBACK_PENDING,REPORTS_FSM_PARAM_TENANT,ACTION_TEST_FSM_DAILY_DESLUDING_REPORT,ACTION_TEST_FSM_AREA_WISE_COLLECTION_REPORT,ACTION_TEST_FSM_FSTP_PLANT_WITH_VEHICLE_LOG_REPORT,REPORT_FSM_RESULT_VEHICLEENTRYDATE,REPORT_FSM_RESULT_SLA_COMPLIANCE
        keyOrder: message,code
        tableName: fsm_status_keys
    sourceColumns:
      - name: applicationno
        label: REPORT_FSM_RESULT_APPLICATIONNO
        type: string
        source: fsm
      - name: applicationDate
        label: REPORT_FSM_RESULT_APPLICATIONDATE
        type: string
        source: fsm
      - name: currentStatus
        label: REPORT_FSM_RESULT_CURRENT_STATUS
        type: string
        source: fsm
      - name: dsoName
        label: REPORT_FSM_RESULT_DSO_NAME
        type: string
        source: fsm
      - name: amountpaid
        label: REPORT_FSM_RESULT_AMOUNT_PAID
        type: currency
        source: fsm
        total: true
      - name: dateOfCompletion
        label: REPORT_FSM_RESULT_DATE_OF_COMPLETION
        type: string
        source: fsm
    searchParams:
      - name: fromDate
        label: REPORTS_FSM_PARAM_FROMDATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime >= $fromDate
      - name: toDate
        label: REPORTS_FSM_PARAM_TODATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime <= $toDate
      - name: ulb
        label: REPORTS_FSM_PARAM_TENANT
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants| $.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND app.tenantid in ($ulb)
      - name: dsoId
        label: REPORTS_FSM_PARAM_DSONAME
        type: singlevaluelist
        pattern: http://vendor.sanitation:8080/vendor/v1/_search?tenantId=$tenantid|$.vendor.*.id|$.vendor.*.name
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND app.dso_id = $dsoId
    query: |
      SELECT app.applicationno, to_char(to_timestamp(app.createdtime/1000),'DD/MM/YYYY') as applicationDate, CASE WHEN (statuskeys.message='' or statuskeys.message is NULL) THEN 'NA' ELSE statuskeys.message END  as currentStatus, vendor.name as dsoname, coalesce(payment.amountpaid) as amountpaid,CASE WHEN picomplete.lastmodifiedtime <= 0  THEN 'NA' ELSE to_char(to_timestamp(picomplete.lastmodifiedtime/1000),'DD/MM/YYYY')  END as dateOfCompletion from eg_fsm_application app inner join eg_vendor vendor ON  (app.dso_id =vendor.id) LEFT  JOIN egcl_bill bill ON ( bill.consumercode = app.applicationno) LEFT  JOIN egcl_paymentdetail payment ON ( payment.billid = bill.id ) LEFT  JOIN (select pi.businessId,pi.lastmodifiedtime from eg_wf_processinstance_v2 pi JOIN eg_wf_state_v2 status ON ( status.uuid =pi.status) where pi.businessService LIKE 'FSM%' AND status.applicationstatus IN ('CITIZEN_FEEDBACK_PENDING','COMPLETED')) picomplete ON ( picomplete.businessId = app.applicationno) LEFT  JOIN (VALUES fsm_status_keys) statuskeys(message,code) ON ( statuskeys.code = CONCAT('CS_COMMON_FSM_',app.applicationstatus)) where app.tenantid=$tenantid
    orderby: order by app.createdtime  desc

  - reportName: FSMAreaWiseDailyCollectionReport
    summary: Report is used to  check area wise daily collection report 
    version: 1.0.0
    moduleName: fsm
    externalService:
      - entity: $.TenantBoundary[0].boundary
        apiURL: http://egov-location.egov:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=ADMIN&boundaryType=Locality&tenantId=$tenantId
        keyOrder: name,code
        tableName: fsm_boundary
      - entity: $.messages
        apiURL: http://egov-localization.egov:8080/localization/messages/v1/_search?locale=en_IN&tenantId=pg&module=rainmaker-fsm&codes=CS_COMMON_FSM_PENDING_DSO_APPROVAL,CS_COMMON_FSM_CREATED,CS_COMMON_FSM_PENDING_APPL_FEE_PAYMENT,CS_COMMON_FSM_ASSING_DSO,CS_COMMON_FSM_DSO_REJECTED,CS_COMMON_FSM_DSO_INPROGRESS,CS_COMMON_FSM_PENDING_DSO_APPROVAL,CS_COMMON_FSM_COMPLETED,CS_COMMON_FSM_REJECTED,CS_COMMON_FSM_CANCELED,CS_COMMON_FSM_CITIZEN_FEEDBACK_PENDING,REPORTS_FSM_PARAM_TENANT,ACTION_TEST_FSM_DAILY_DESLUDING_REPORT,ACTION_TEST_FSM_AREA_WISE_COLLECTION_REPORT,ACTION_TEST_FSM_FSTP_PLANT_WITH_VEHICLE_LOG_REPORT,REPORT_FSM_RESULT_VEHICLEENTRYDATE,REPORT_FSM_RESULT_SLA_COMPLIANCE
        keyOrder: message,code
        tableName: fsm_status_keys
    sourceColumns:
      - name: applicationno
        label: REPORT_FSM_RESULT_APPLICATIONNO
        type: string
        source: fsm
      - name: locality
        label: REPORT_FSM_RESULT_LOCALITY
        type: string
        source: fsm
      - name: dsoName
        label: REPORT_FSM_RESULT_DSO_NAME
        type: string
        source: fsm
      - name: currentStatus
        label: REPORT_FSM_RESULT_CURRENT_STATUS
        type: string
        source: fsm
      - name: slaCompliance
        label: REPORT_FSM_RESULT_SLA_COMPLIANCE
        type: string
        source: fsm
        total: true
      - name: septagedumped
        label: REPORT_FSM_RESULT_SEPTAGEDUMPED
        type: string
        source: fsm
        total: true
    searchParams:
      - name: fromDate
        label: REPORTS_FSM_PARAM_FROMDATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime >= $fromDate
      - name: toDate
        label: REPORTS_FSM_PARAM_TODATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime <= $toDate
      - name: ulb
        label: REPORTS_FSM_PARAM_TENANT
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants| $.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: fsm
        wrapper: true
        isMandatory: true
        searchClause: AND app.tenantid in ($ulb)
      - name: locality
        label: REPORTS_FSM_PARAM_LOCALITY
        type: singlevaluelist
        pattern: http://egov-location.egov:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=ADMIN&boundaryType=Locality&tenantId=$tenantid|$.TenantBoundary[0].boundary.*.code|$.TenantBoundary[0].boundary.*.name
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND address.locality = $locality
      - name: dsoId
        label: REPORTS_FSM_PARAM_DSONAME
        type: singlevaluelist
        pattern: http://vendor.sanitation:8080/vendor/v1/_search?tenantId=$tenantid|$.vendor.*.id|$.vendor.*.name
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND app.dso_id = $dsoId
    query: |
      SELECT app.applicationno, boundary.name as locality, vendor.name as dsoname, statuskeys.message as currentStatus, CASE WHEN app.applicationstatus = 'COMPLETED' THEN DATE_PART('day', AGE(to_timestamp(app.createdtime/1000), to_timestamp(app.completed_on/1000))) ELSE ((DATE_PART('day', AGE(to_timestamp(app.createdtime/1000), to_timestamp((EXTRACT(EPOCH FROM (SELECT NOW())))/1000))))) END as slaCompliance, vhtrip.volumecarried as septagedumped from eg_fsm_application app JOIN eg_fsm_address address ON ( address.fsm_id = app.id) LEFT JOIN eg_vendor vendor ON  (app.dso_id =vendor.id) LEFT JOIN eg_wf_processinstance_v2 pi ON (pi.businessId=app.applicationno) LEFT JOIN eg_vehicle_trip_detail vhtripdtl  on (app.applicationno=vhtripdtl.referenceno) LEFT JOIN eg_vehicle_trip vhtrip on (vhtripdtl.trip_id=vhtrip.id) LEFT  JOIN (VALUES fsm_boundary) AS boundary(name,code) ON (boundary.code = address.locality) LEFT  JOIN (VALUES fsm_status_keys) statuskeys(message,code) ON ( statuskeys.code = CONCAT('CS_COMMON_FSM_',app.applicationstatus)) where app.tenantid=$tenantid
    orderby: order by app.createdtime  desc


  - reportName: FSMFSTPPlantWithVehicleLogReport
    summary: Report is used to  check ftsp plant report along with vehicle log
    version: 1.0.0
    moduleName: fsm
    sourceColumns:
      - name: applicationno
        label: REPORT_FSM_RESULT_APPLICATIONNO
        type: string
        source: fsm
      - name: vehicleno
        label: REPORT_FSM_RESULT_VEHICLENO
        type: string
        source: fsm
        total: false
      - name: vehicleentrydate
        label: REPORT_FSM_RESULT_VEHICLEENTRYDATE
        type: string
        source: fsm
        total: false
      - name: dsoName
        label: REPORT_FSM_RESULT_DSO_NAME
        type: string
        source: fsm
      - name: vehicleentrytime
        label: REPORT_FSM_RESULT_VEHICLEENTRYTIME
        type: string
        source: fsm
        total: false
      - name: vehicleexittime
        label: REPORT_FSM_RESULT_VEHICLEEXITTIME
        type: string
        source: fsm
        total: false
      - name: septagedumped
        label: REPORT_FSM_RESULT_SEPTAGEDUMPED
        type: string
        source: fsm
        total: true
    searchParams:
      - name: fromDate
        label: REPORTS_FSM_PARAM_FROMDATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime >= $fromDate
      - name: toDate
        label: REPORTS_FSM_PARAM_TODATE
        type: epoch
        source: fsm
        isMandatory: true
        searchClause: AND app.createdtime <= $toDate
      - name: ulb
        label: REPORTS_FSM_PARAM_TENANT
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants| $.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
        source: fsm
        wrapper: true
        isMandatory: true
        searchClause: AND app.tenantid in ($ulb)
      - name: fstpcode
        label: REPORTS_FSM_PARAM_FSTPNAME
        type: multivaluelist
        pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=FSM&masterName=FSTPPlantInfo| $.MdmsRes.FSM.FSTPPlantInfo.*.PlantCode|$.MdmsRes.FSM.FSTPPlantInfo.*.PlantName
        source: fsm
        wrapper: true
        isMandatory: true
        searchClause: AND vhtrip.additionaldetails ::json ->>'plantCode ' in ($fstpcode)
      - name: dsoId
        label: REPORTS_FSM_PARAM_DSONAME
        type: singlevaluelist
        pattern: http://vendor.sanitation:8080/vendor/v1/_search?tenantId=$tenantid|$.vendor.*.id|$.vendor.*.name
        source: fsm
        wrapper: true
        isMandatory: false
        searchClause: AND app.dso_id = $dsoId
      - name: vehicleNo
        label: REPORTS_FSM_PARAM_VEHICLENUMBER
        type: string
        source: fsm
        isMandatory: false
        searchClause: AND vehicle.registrationnumber ilike '%'||$vehicleNo||'%'
    query: |
      select  app.applicationno as applicationno, vendor.name as dsoname, vehicle.registrationnumber as vehicleno, to_char(to_timestamp(vhtrip.createdtime/1000),'DD/MM/YYYY') as vehicleentrydate, to_char((to_timestamp(vhtrip.tripstarttime)::timestamp  at time zone 'utc' at time Zone 'Asia/Kolkata'), 'HH12:MI:SS AM') as vehicleentrytime, to_char((to_timestamp(vhtrip.tripendtime)::timestamp at time zone 'utc' at time Zone 'Asia/Kolkata'), 'HH12:MI:SS AM') as vehicleexittime, vhtrip.volumecarried as septagedumped from eg_fsm_application app join eg_vehicle_trip_detail vhtripdtl  on app.applicationno=vhtripdtl.referenceno join eg_vehicle_trip vhtrip on vhtripdtl.trip_id=vhtrip.id left join eg_vehicle vehicle on vhtrip.vehicle_id=vehicle.id left join eg_vendor vendor ON  app.dso_id =vendor.id where app.tenantid=$tenantid
    orderby: order by app.createdtime  desc
